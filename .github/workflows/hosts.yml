
name: hosts

on:
  schedule:
    # Runs at 00:00 UTC every day.
    - cron: '0 0,6,12,18 * * *'

  workflow_dispatch:
    inputs:
      dns:
        description: 'DNS'
        required: true
        default: 'Aliyun'
        type: choice
        options:
        - 'Google'
        - 'Aliyun'

jobs:
  hosts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@main
      
      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Init Env
        run : |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          sudo timedatectl set-timezone "Asia/Shanghai"
          python -m pip install --upgrade pip setuptools
          python -m pip install requests

      - name: Get Github Hosts
        shell: python
        run: |
          import time, requests

          class dnsChecker():
              def __init__(self) -> None:
                  self.dnsServers = {
                      "Google": "https://dns.google/resolve?name={}&type={}",
                      "Aliyun": "https://dns.alidns.com/resolve?name={}&type={}",
                  }
                  self.dnsidx = 'Google'

              def setServers(self, provider: str) -> None:
                  if provider in self.dnsServers:
                      self.dnsidx = provider

              def getServers(self):
                  return self.dnsidx

              def _query(self, qname: str, rdtype: str):
                  servers = getattr(self, 'dnsidx', 'Google')
                  url = self.dnsServers.get(self.dnsidx).format(qname, rdtype)
                  resp = requests.get(url, timeout=5)
                  if resp.status_code != 200:
                      return None
                  return resp.json()

              def check(self, qname: str, rdtype: str):
                  try:
                      data = self._query(qname, rdtype)
                      if not data or data.get('Status') != 0:
                          return False, []
                      answers = data.get('Answer') or []
                      ips = [a.get('data') for a in answers if a.get('data') and a.get('type') in (1, 28)]
                      if ips:
                          return True, [ips[0]]
                      # 回退：尝试 CNAME
                      cname_data = self._query(qname, 'CNAME')
                      if cname_data and cname_data.get('Status') == 0:
                          c_answers = cname_data.get('Answer') or []
                          cnames = [a.get('data').rstrip('.') for a in c_answers if a.get('type') == 5 and a.get('data')]
                          for target in cnames:
                              a_data = self._query(target, 'A')
                              if a_data and a_data.get('Status') == 0:
                                  a_ans = a_data.get('Answer') or []
                                  a_ips = [a.get('data') for a in a_ans if a.get('type') == 1]
                                  if a_ips:
                                      return True, [a_ips[0]]
                      return False, []
                  except Exception:
                      return False, []

          if __name__ == '__main__':
              gitHubDoMains = [
                  "github.io",
                  "github.com",
                  "github.blog",
                  "github.community",
                  "api.github.com",
                  "api.githubcopilot.com",
                  "gist.github.com",
                  "codeload.github.com",
                  "central.github.com",
                  "collector.github.com",
                  "raw.github.com",
                  "docs.github.com",
                  "assets-cdn.github.com",
                  "raw.githubusercontent.com",
                  "camo.githubusercontent.com",
                  "cloud.githubusercontent.com",
                  "media.githubusercontent.com",
                  "desktop.githubusercontent.com",
                  "objects.githubusercontent.com",
                  "favicons.githubusercontent.com",
                  "avatars5.githubusercontent.com",
                  "avatars4.githubusercontent.com",
                  "avatars3.githubusercontent.com",
                  "avatars2.githubusercontent.com",
                  "avatars1.githubusercontent.com",
                  "avatars0.githubusercontent.com",
                  "avatars.githubusercontent.com",
                  "user-images.githubusercontent.com",
                  "copilot-proxy.githubusercontent.com",
                  "github-releases.githubusercontent.com",
                  "pipelines.actions.githubusercontent.com",
                  "pipelinesghubeus7.actions.githubusercontent.com",
                  "githubstatus.com",
                  "collector.githubapp.com",
                  "github.githubassets.com",
                  "analytics.githubassets.com",
                  "github.map.fastly.net",
                  "github.global.ssl.fastly.net",
                  "github-cloud.s3.amazonaws.com",
                  "github-com.s3.amazonaws.com",
                  "github-production-release-asset-2e65be.s3.amazonaws.com",
                  "github-production-user-asset-6210df.s3.amazonaws.com",
                  "github-production-repository-file-5c1aeb.s3.amazonaws.com"
              ]

              dockerDoMains = [
                  "registry.hub.docker.com",
                  "hub.docker.com",
                  "index.docker.io",
                  "ghcr.io",
                  "gcr.io",
                  "k8s.gcr.io",
                  "quay.io"
              ]

              tMMDoMains = [
                  "themoviedb.org",
                  "www.themoviedb.org",
                  "api.themoviedb.org",
                  "tmdb.org",
                  "api.tmdb.org",
                  "image.tmdb.org",
                  "opensubtitles.org",
                  "www.opensubtitles.org",
                  "api.opensubtitles.org",
                  "assets.fanart.tv"
              ]

              dnsobj = dnsChecker()
              dnsservers = 'Google'
              if '${{ inputs.dns }}' != '':
                  dnsservers = '${{ inputs.dns }}'
              dnsobj.setServers(dnsservers)
              dnsList = []
              dnsList.append('# ING Hosts Start')
              dnsList.append('# Raw Url: https://raw.githubusercontent.com/wjz304/hosts/main/hosts')
              dnsList.append('# CDN Url: https://gcore.jsdelivr.net/gh/wjz304/hosts@main/hosts')
              dnsList.append('# CDN Url: https://cdn.staticaly.com/gh/wjz304/hosts/main/hosts')
              dnsList.append('# DNS Servers: {}'.format(dnsobj.getServers()))
              dnsList.append('# Update at: {}'.format(time.strftime("%Y-%m-%d %H:%M:%S")))
              # GitHub
              dnsList.append('# GitHub Hosts Start')
              for domain in gitHubDoMains:
                  ret, ips = dnsobj.check(domain, 'A')
                  if ret == True:
                      for ip in ips:
                          dnsList.append((ip.ljust(16) + domain))
                          break  # 只取第一个吧
              dnsList.append('# GitHub Hosts End')

              # Docker
              dnsList.append('# Docker Hosts Start')
              for domain in dockerDoMains:
                  ret, ips = dnsobj.check(domain, 'A')
                  if ret == True:
                      for ip in ips:
                          dnsList.append((ip.ljust(16) + domain))
                          break  # 只取第一个吧
              dnsList.append('# Docker Hosts End')

              # TMM
              dnsList.append('# TMM Hosts Start')
              for domain in tMMDoMains:
                  ret, ips = dnsobj.check(domain, 'A')
                  if ret == True:
                      for ip in ips:
                          dnsList.append((ip.ljust(16) + domain))
                          break  # 只取第一个吧
              dnsList.append('# TMM Hosts End')

              dnsList.append('# ING Hosts End')

              with open('hosts', 'w', encoding="utf-8") as f:
                  f.writelines('\n'.join(dnsList))

      - name: Check and Push
        run: |
          if [ -n "$(git status -s | grep hosts)" ]; then
            git add hosts
            git commit -m "update $(date +%Y-%m-%d" "%H:%M:%S)"
            git push -f
          fi

